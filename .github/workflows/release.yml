name: Release Please

on:
  push:
    branches: [main]

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  release-please:
    name: Release Please
    runs-on: ubuntu-latest

    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      skills_release_created: ${{ steps.release.outputs['.claude-plugin--release_created'] }}

    steps:
      - name: Release Please
        id: release
        uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38 # v4.4.0
        with:
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  goreleaser:
    name: GoReleaser (${{ matrix.os }})
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
          - os: ubuntu-24.04-arm
            goos: linux
            goarch: arm64
          - os: macos-15-intel
            goos: darwin
            goarch: amd64
          - os: macos-latest
            goos: darwin
            goarch: arm64

    runs-on: ${{ matrix.os }}

    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0
          ref: ${{ needs.release-please.outputs.tag_name }}

      - name: Set up Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version: stable

      - name: Login to GitHub Container Registry
        if: matrix.goos == 'linux'
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6.4.0
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean --skip=validate,homebrew${{ matrix.goos == 'darwin' && ',docker' || '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}

  homebrew:
    name: Update Homebrew Formula
    needs: [release-please, goreleaser]
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0
          ref: ${{ needs.release-please.outputs.tag_name }}

      - name: Set up Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version: stable

      - name: Download release artifacts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p dist
          TAG="${{ needs.release-please.outputs.tag_name }}"
          VERSION="${TAG#v}"

          # Download all archives and checksums from the release
          gh release download "$TAG" --pattern "*.tar.gz" --dir dist
          gh release download "$TAG" --pattern "checksums_*.txt" --dir dist

          # Merge all checksum files into one
          cat dist/checksums_*.txt | sort > dist/checksums.txt

      - name: Upload consolidated checksums
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.release-please.outputs.tag_name }}"
          gh release upload "$TAG" dist/checksums.txt --clobber

      - name: Generate Homebrew formula
        env:
          HOMEBREW_TAP_GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.release-please.outputs.tag_name }}"
          VERSION="${TAG#v}"

          # Calculate SHA256 for each archive
          DARWIN_AMD64_SHA=$(sha256sum dist/omen_${VERSION}_darwin_amd64.tar.gz | cut -d' ' -f1)
          DARWIN_ARM64_SHA=$(sha256sum dist/omen_${VERSION}_darwin_arm64.tar.gz | cut -d' ' -f1)
          LINUX_AMD64_SHA=$(sha256sum dist/omen_${VERSION}_linux_amd64.tar.gz | cut -d' ' -f1)
          LINUX_ARM64_SHA=$(sha256sum dist/omen_${VERSION}_linux_arm64.tar.gz | cut -d' ' -f1)

          # Generate the formula
          cat > omen.rb << EOF
          class Omen < Formula
            desc "Multi-language code analysis CLI"
            homepage "https://github.com/panbanda/omen"
            version "${VERSION}"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/panbanda/omen/releases/download/${TAG}/omen_${VERSION}_darwin_arm64.tar.gz"
                sha256 "${DARWIN_ARM64_SHA}"
              else
                url "https://github.com/panbanda/omen/releases/download/${TAG}/omen_${VERSION}_darwin_amd64.tar.gz"
                sha256 "${DARWIN_AMD64_SHA}"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/panbanda/omen/releases/download/${TAG}/omen_${VERSION}_linux_arm64.tar.gz"
                sha256 "${LINUX_ARM64_SHA}"
              else
                url "https://github.com/panbanda/omen/releases/download/${TAG}/omen_${VERSION}_linux_amd64.tar.gz"
                sha256 "${LINUX_AMD64_SHA}"
              end
            end

            def install
              bin.install "omen"
            end

            test do
              system "#{bin}/omen", "--version"
            end
          end
          EOF

          # Clone the tap repo and update the formula
          git clone "https://x-access-token:${HOMEBREW_TAP_GITHUB_TOKEN}@github.com/panbanda/homebrew-omen.git" tap
          mkdir -p tap/Formula
          cp omen.rb tap/Formula/omen.rb

          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/omen.rb
          git commit -m "Update omen to ${VERSION}"
          git push

  docker-manifest:
    name: Create Docker Manifest
    needs: [release-please, goreleaser]
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest

    permissions:
      packages: write

    steps:
      - name: Login to GitHub Container Registry
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push manifest
        env:
          TAG: ${{ needs.release-please.outputs.tag_name }}
        run: |
          VERSION="${TAG#v}"
          docker manifest create ghcr.io/panbanda/omen:${VERSION} \
            ghcr.io/panbanda/omen:${VERSION}-amd64 \
            ghcr.io/panbanda/omen:${VERSION}-arm64
          docker manifest push ghcr.io/panbanda/omen:${VERSION}

          docker manifest create ghcr.io/panbanda/omen:latest \
            ghcr.io/panbanda/omen:${VERSION}-amd64 \
            ghcr.io/panbanda/omen:${VERSION}-arm64
          docker manifest push ghcr.io/panbanda/omen:latest

  mcp-registry:
    name: Publish MCP Manifest
    needs: [release-please, docker-manifest]
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest

    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0
          ref: ${{ needs.release-please.outputs.tag_name }}

      - name: Set up Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version: stable

      - name: Publish MCP manifest
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6.4.0
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean --skip=announce,archive,aur,aur-source,before,chocolatey,docker,homebrew,ko,makeself,nfpm,nix,notarize,publish,sbom,scoop,sign,snapcraft,validate,winget
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
