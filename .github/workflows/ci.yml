name: CI

on:
  push:
    branches: [main]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version: stable

      - name: Test
        run: go test -race ./...

      - name: Build
        run: go build -o omen ./cmd/omen

  coverage:
    name: Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version: stable

      - name: Test with coverage
        run: go test -race -coverprofile=coverage.out ./...

      - name: Check coverage threshold
        run: |
          # Extract total coverage percentage
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Total coverage: ${COVERAGE}%"

          # Fail if coverage is below 60%
          THRESHOLD=60
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "ERROR: Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
            exit 1
          fi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: true

  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version: stable

      - name: Lint
        uses: golangci/golangci-lint-action@4afd733a84b1f43292c63897423277bb7f4313a9 # v8.0.0
        with:
          version: latest

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version: stable

      # Vulnerability scanning with govulncheck (reachability-aware)
      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run govulncheck
        run: govulncheck ./...

      # Security scanning with gosec (SARIF output for GitHub Security)
      - name: Run gosec
        uses: securego/gosec@v2.22.4
        with:
          args: '-fmt sarif -out gosec-results.sarif ./...'

      - name: Upload gosec SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: gosec-results.sarif

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          deny-licenses: GPL-3.0, AGPL-3.0
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC, MPL-2.0

  license-check:
    name: License Compliance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version: stable

      - name: Install go-licenses
        run: go install github.com/google/go-licenses@latest

      - name: Check licenses
        run: |
          # Check for disallowed licenses
          go-licenses check ./... \
            --disallowed_types=forbidden,restricted,reciprocal,unknown \
            --ignore github.com/panbanda/omen 2>&1 || {
            echo "WARNING: License check found issues (review manually)"
          }

      - name: Generate license report
        run: |
          go-licenses report ./... --template='{{range .}}{{.Name}}: {{.LicenseName}}{{"\n"}}{{end}}' \
            --ignore github.com/panbanda/omen > licenses.txt 2>/dev/null || true
          echo "=== Dependency Licenses ==="
          cat licenses.txt || echo "No licenses found"

  sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version: stable

      - name: Install syft
        uses: anchore/sbom-action/download-syft@v0

      - name: Generate CycloneDX SBOM
        run: syft packages dir:. -o cyclonedx-json=sbom.cdx.json

      - name: Generate SPDX SBOM
        run: syft packages dir:. -o spdx-json=sbom.spdx.json

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: |
            sbom.cdx.json
            sbom.spdx.json
          retention-days: 90

  complexity:
    name: Complexity Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version: stable

      - name: Build omen
        run: go build -o omen ./cmd/omen

      # Use omen itself to enforce complexity limits
      - name: Check cyclomatic complexity
        run: |
          # Fail if any function has cyclomatic complexity > 15
          ./omen analyze complexity --format json | \
            jq -e '[.files[].functions[] | select(.cyclomatic > 15)] | length == 0' || \
            (echo "ERROR: Functions with cyclomatic complexity > 15 found" && \
             ./omen analyze complexity --format json | \
             jq '.files[].functions[] | select(.cyclomatic > 15) | {file: .file, name: .name, cyclomatic: .cyclomatic}' && \
             exit 1)

      - name: Check cognitive complexity
        run: |
          # Fail if any function has cognitive complexity > 20
          ./omen analyze complexity --format json | \
            jq -e '[.files[].functions[] | select(.cognitive > 20)] | length == 0' || \
            (echo "ERROR: Functions with cognitive complexity > 20 found" && \
             ./omen analyze complexity --format json | \
             jq '.files[].functions[] | select(.cognitive > 20) | {file: .file, name: .name, cognitive: .cognitive}' && \
             exit 1)

  code-quality:
    name: Code Quality Gates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version: stable

      - name: Build omen
        run: go build -o omen ./cmd/omen

      - name: Check for code duplication
        run: |
          # Use omen's duplicate detection
          DUPES=$(./omen analyze duplicates --format json 2>/dev/null | jq '.clones | length')
          MAX_DUPES=10
          if [ "$DUPES" -gt "$MAX_DUPES" ]; then
            echo "ERROR: Found $DUPES duplicate code blocks (max: $MAX_DUPES)"
            ./omen analyze duplicates --format json | jq '.clones[:5]'
            exit 1
          fi
          echo "OK: Found $DUPES duplicate blocks (threshold: $MAX_DUPES)"

      - name: Check file sizes
        run: |
          # Fail if any Go file exceeds 800 lines (excluding generated/test files)
          MAX_LINES=800
          LARGE_FILES=$(find . -name '*.go' -not -name '*_test.go' -not -path './vendor/*' -not -name '*.gen.go' -not -name '*_generated.go' | while read f; do
            LINES=$(wc -l < "$f")
            if [ "$LINES" -gt "$MAX_LINES" ]; then
              echo "$f: $LINES lines"
            fi
          done)

          if [ -n "$LARGE_FILES" ]; then
            echo "ERROR: Files exceeding $MAX_LINES lines:"
            echo "$LARGE_FILES"
            exit 1
          fi
          echo "OK: All files within size limits"

      - name: Check technical debt markers
        run: |
          # Use omen's SATD detection
          SATD_COUNT=$(./omen analyze satd --format json 2>/dev/null | jq '[.files[].comments[]] | length')
          MAX_SATD=50
          if [ "$SATD_COUNT" -gt "$MAX_SATD" ]; then
            echo "WARNING: Found $SATD_COUNT technical debt markers (threshold: $MAX_SATD)"
            ./omen analyze satd --format json | jq '.files[] | select(.comments | length > 0) | {file: .file, count: (.comments | length)}'
          else
            echo "OK: Found $SATD_COUNT technical debt markers (threshold: $MAX_SATD)"
          fi

  documentation:
    name: Documentation Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version: stable

      - name: Check package documentation
        run: |
          # Find packages missing doc.go or package comments
          MISSING_DOCS=""
          for pkg in $(find ./pkg ./internal -type d -mindepth 1 -maxdepth 2); do
            if [ -z "$(ls -A $pkg/*.go 2>/dev/null)" ]; then
              continue
            fi

            # Check for package comment in any .go file
            HAS_PKG_COMMENT=$(grep -l "^// Package " $pkg/*.go 2>/dev/null | head -1)
            if [ -z "$HAS_PKG_COMMENT" ]; then
              MISSING_DOCS="$MISSING_DOCS\n  - $pkg"
            fi
          done

          if [ -n "$MISSING_DOCS" ]; then
            echo "WARNING: Packages missing package-level documentation:$MISSING_DOCS"
          else
            echo "OK: All packages have documentation"
          fi

      - name: Check exported function documentation
        run: |
          # Use go vet's stdmethods check and custom check for missing comments
          go install golang.org/x/tools/cmd/godoc@latest

          # Count exported functions/types without comments
          UNDOC=$(go doc -all ./... 2>&1 | grep -c "^func [A-Z]" || true)
          echo "Exported symbols found: $UNDOC"

  circular:
    name: Circular Dependency Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version: stable

      - name: Build omen
        run: go build -o omen ./cmd/omen

      - name: Check for circular dependencies
        run: |
          # Fail if any circular dependencies are detected
          ./omen analyze smells --format json | \
            jq -e '.cycles | length == 0' || \
            (echo "ERROR: Circular dependencies detected" && \
             ./omen analyze smells --format json | jq '.cycles' && \
             exit 1)

      - name: Check for architectural smells
        run: |
          # Warn on hub components (too many dependencies)
          HUBS=$(./omen analyze smells --format json | jq '.hub_components | length')
          if [ "$HUBS" -gt 0 ]; then
            echo "WARNING: Found $HUBS hub components with excessive dependencies:"
            ./omen analyze smells --format json | jq '.hub_components'
          fi

          # Warn on god components
          GODS=$(./omen analyze smells --format json | jq '.god_components | length')
          if [ "$GODS" -gt 0 ]; then
            echo "WARNING: Found $GODS god components:"
            ./omen analyze smells --format json | jq '.god_components'
          fi

  depcheck:
    name: Dependency Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version: stable

      - name: Verify go.mod is tidy
        run: |
          go mod tidy
          git diff --exit-code go.mod go.sum || \
            (echo "ERROR: go.mod or go.sum is not tidy. Run 'go mod tidy' and commit." && exit 1)

      - name: Check for deprecated dependencies
        run: |
          # List direct dependencies and check for deprecation notices
          go list -m -u -json all 2>/dev/null | \
            jq -r 'select(.Deprecated != null) | "\(.Path): \(.Deprecated)"' | \
            tee deprecated.txt
          if [ -s deprecated.txt ]; then
            echo "WARNING: Deprecated dependencies found (not failing build)"
          fi

      - name: Check for outdated dependencies
        run: |
          # Show available updates
          echo "=== Available Updates ==="
          go list -m -u -json all 2>/dev/null | \
            jq -r 'select(.Update != null) | "\(.Path): \(.Version) -> \(.Update.Version)"' | \
            head -20 || true

  deadcode:
    name: Dead Code Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version: stable

      - name: Build omen
        run: go build -o omen ./cmd/omen

      - name: Check for unused code
        run: |
          # Use omen's deadcode detection
          UNUSED=$(./omen analyze deadcode --format json 2>/dev/null | jq '.unused_functions | length')
          MAX_UNUSED=20
          if [ "$UNUSED" -gt "$MAX_UNUSED" ]; then
            echo "WARNING: Found $UNUSED unused functions (threshold: $MAX_UNUSED)"
            ./omen analyze deadcode --format json | jq '.unused_functions[:10]'
          else
            echo "OK: Found $UNUSED unused functions (threshold: $MAX_UNUSED)"
          fi
